# Day 1 - Introduction

## WHAT IS HEAP?
Bài đầu tiên, chúng ta sẽ tìm hiểu Heap là gì.

Một chương trình C điển hình có cấu trúc bộ nhớ bao gồm 5 phần:
1. **Text segment**: chứa code thực thi của chương trình.
2. **Data segment**: chứa các biến global và biến static đã được khởi tạo giá trị bởi người dùng.
3. **BSS segment**: chứa các biến global và biến static không được khởi tạo giá trị một cách tường minh.
4. **Heap**: chứa dữ liệu được cấp phát động bởi người dùng.
5. **Stack**: được cấu trúc thành từng frame, mỗi frame là vùng nhớ riêng của một hàm, được sắp xếp theo thứ tự lời gọi hàm. 

![memoryLayoutC.jpg](memoryLayoutC.jpg)

Bộ nhớ Heap phát triển theo hướng từ địa chỉ thấp đến địa chỉ cao (ngược lại vào Stack), được cấu tạo thành các đơn vị bộ nhớ gọi là chunk với kích thước tùy thuộc vào người dùng yêu cầu. Mỗi khi người dùng gọi hàm `malloc()` (hay các hàm tương tự như calloc(), realloc(), ...), bộ nhớ sẽ cấp phát 1 vùng nhớ với kích thước phù hợp. Khi không dùng đến nữa, người dùng sẽ giải phóng vùng nhớ đó thông qua hàm `free` để có thể sử dụng lại vùng nhớ đó sau này (nhằm tiết kiệm bộ nhớ).

Một chunk sẽ có 1 trong 2 trạng thái: `allocated` hoặc `freed`.

## HEAP RULES
Heap giúp cho việc sử dụng bộ nhớ hiệu quả hơn, tuy nhiên để sử dụng nó một cách hiệu quả và an toàn người dùng cần tuân thủ các nguyên tắc sau:
1. Không đọc hoặc ghi vào một chunk nhớ đã `freed`.
	Nếu không sẽ đẫn đến lỗi **user after free**.
2. Không sử dụng hoặc leak thông tin chưa được khởi tạo trong một chunk.
	Nếu không sẽ đẫn đến lỗi **information leaks** hoặc **uninitialized data**.
3. Không đọc hoặc ghi vào các bytes nằm sau một chunk.
	Nếu không sẽ đẫn đến lỗi **heap overflow** hoặc **read beyond bounds**.
4. Không `free()` một chunk 2 lần.
	Nếu không sẽ đẫn đến lỗi **double free**.
5. Không đọc hoặc ghi vào các bytes nằm trước một chunk.
	Nếu không sẽ đẫn đến lỗi **heap underflow**.
6. Không `free()` một con trỏ chưa được khởi tạo bởi hàm `malloc()`.
	Nếu không sẽ đẫn đến lỗi **invalid free**.
7. Không sử dụng một con trỏ được khởi tạo bởi hàm `malloc()` nếu return value của `malloc` là NULL.
	Nếu không sẽ đẫn đến lỗi **arbitrary write**.

## CHUNK ALLOCATION STRATEGIES
Mỗi khi người dùng yêu cầu cấp phát (allocate) một vùng nhớ. Bộ nhớ sẽ theo chiến lược sau:
1. Nếu có một chunk nhớ đã free trước đó, và kích thước của nó đủ lớn so với yêu cầu của người dùng. Bộ nhớ sẽ cấp phát vùng nhớ đó.
2. Ngược lại, nếu có một vùng nhớ đủ lớn ở đỉnh của heap, bộ nhớ sẽ cấp phát vùng nhớ đó.
3. Ngược lại, bộ nhớ sẽ yêu cầu kernel cấp thêm vùng nhớ mới với đỉnh của heap và sử dụng nó cấp phát cho người dùng.
4. Nếu tất cả các chiến lược trên đều fail, bộ nhớ không thể allocate, `malloc()` sẽ return NULL.

#### ALLOCATING FROM FREE'D CHUNKS.
Các chunk đã được free sẽ được đưa vào các **bin**. **Bin** là danh sách dùng để truy dấu các chunks đã free. Có nhiều loại **bin**, Mỗi loại gồm nhiều **bin**. Mỗi **bin** được cấu trúc dưới dạng **single linked list** hoặc **double linked list**. Mỗi node của **bin** là một chunk, có chứa con trỏ **FD** và **BK** để trỏ tới các chunk kế bên trong **bin**.

![bins-simple.png](bins-simple.png)

#### ALLOCATING FROM THEM TOP OF THE HEAP.
Chunk nằm ở đỉnh heap được gọi là **top chunk** hoặc **remainder chunk**. Nếu không có chunk nào trong bin có thể allocate, bộ nhớ sẽ cấp phát vùng nhớ mới từ top chunk.

![heap-chunks-top.gif](heap-chunks-top.gif)

## CHUNK STRUCTURE
Một chunk có 2 trạng thái: `allocated` và `freed`, tùy vào trạng thái của chunk mà cấu trúc chunk sẽ khác nhau. Mỗi chunk dù là `in_use` hay `freed` đều có vùng `metadata` để chứa thông tin về chunk đó.

#### ALLOCATED CHUNK
Metadata của một `allocated chunk` có kích thước 8 bytes (đối với hệ thống 32 bit) hoặc 16 bytes (đối với hệ thống 64 bit) bao gồm:
1. **prev_size**: kích thước của chunk trước nó, nếu nó là `freed chunk`. Không được sử dụng nếu chunk trước đó là `allocated chunk`.
2. **chunk size**: kích thước của chunk hiện tại. Kích thước của chunk luôn là bội số của 4 (đối với 32 bit) hoặc 8 (đối với 64 bit). Do đó 3 bit cuối của **chunk size** luôn là 0. Bộ nhớ tận dụng 3 bit này được ký hiệu là (A,M,P) để lưu trạng thái của chunk.
3. **User Data**: chứa dữ liệu của chunk.

![chunk-allocated-CS.png](chunk-allocated-CS.png)

#### FREED CHUNK
