# Day 1 - Introduction

Bài đầu tiên, chúng ta sẽ tìm hiểu Heap là gì.

Một chương trình C điển hình có cấu trúc bộ nhớ bao gồm 5 phần:
1. **Text segment**: chứa code thực thi của chương trình.
2. **Data segment**: chứa các biến global và biến static đã được khởi tạo giá trị bởi người dùng.
3. **BSS segment**: chứa các biến global và biến static không được khởi tạo giá trị một cách tường minh.
4. **Heap**: chứa dữ liệu được cấp phát động bởi người dùng.
5. **Stack**: được cấu trúc thành từng frame, mỗi frame là vùng nhớ riêng của một hàm, được sắp xếp theo thứ tự lời gọi hàm. 

![memoryLayoutC.jpg](memoryLayoutC.jpg)

Bộ nhớ Heap phát triển theo hướng từ địa chỉ thấp đến địa chỉ cao (ngược lại vào Stack), được cấu tạo thành các đơn vị bộ nhớ gọi là chunk với kích thước tùy thuộc vào người dùng yêu cầu. Mỗi khi người dùng gọi hàm `malloc()` (hay các hàm tương tự như calloc(), realloc(), ...), bộ nhớ sẽ cấp phát 1 vùng nhớ với kích thước phù hợp. Khi không dùng đến nữa, người dùng sẽ giải phóng vùng nhớ đó thông qua hàm `free` để có thể sử dụng lại vùng nhớ đó sau này (nhằm tiết kiệm bộ nhớ).

Một chunk sẽ có 1 trong 2 trạng thái: `in_user` hoặc `freed`.

#### HEAP RULES
Heap giúp cho việc sử dụng bộ nhớ hiệu quả hơn, tuy nhiên để sử dụng nó một cách hiệu quả và an toàn người dùng cần tuân thủ các nguyên tắc sau:
1. Không đọc hoặc ghi vào một chunk nhớ đã `freed`.
	Nếu không sẽ đẫn đến lỗi **user after free**.
2. Không sử dụng hoặc leak thông tin chưa được khởi tạo trong một chunk.
	Nếu không sẽ đẫn đến lỗi **information leaks** hoặc **uninitialized data**.
3. Không đọc hoặc ghi vào các bytes nằm sau một chunk.
	Nếu không sẽ đẫn đến lỗi **heap overflow** hoặc **read beyond bounds**.
4. Không `free()` một chunk 2 lần.
	Nếu không sẽ đẫn đến lỗi **double free**.
5. Không đọc hoặc ghi vào các bytes nằm trước một chunk.
	Nếu không sẽ đẫn đến lỗi **heap underflow**.
6. Không `free()` một con trỏ chưa được khởi tạo bởi hàm `malloc()`.
	Nếu không sẽ đẫn đến lỗi **invalid free**.
7. Không sử dụng một con trỏ được khởi tạo bởi hàm `malloc()` nếu return value của `malloc` là NULL.
	Nếu không sẽ đẫn đến lỗi **arbitrary write**.